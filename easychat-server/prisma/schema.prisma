// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  // NOTE: When using mysql or sqlserver, uncomment the @db.Text annotations in model Account below
  // Further reading:
  // https://next-auth.js.org/adapters/prisma#create-the-prisma-schema
  // https://www.prisma.io/docs/reference/api-reference/prisma-schema-reference#string
  url      = env("DATABASE_URL")
}

model User {
  id            String        @id @default(cuid())       // 用户唯一标识符
  chatId        String        @unique                    // 用户聊天ID，全局唯一
  username      String?                                // 用户名，可选
  email         String        @unique                    // 邮箱地址，全局唯一
  emailVerified DateTime?                              // 邮箱验证时间，可选
  avatar        String?                                // 头像图片链接，可选
  password      String                                 // 密码
  gender        String                                 // 性别
  signature     String                                 // 个性签名
  region        String                                 // 地区
  createdAt     DateTime      @default(now())           // 账户创建时间
  updatedAt     DateTime      @updatedAt                // 最后更新时间
  sessions      Session[]                              // 用户会话列表（一对多关系）
  settings      UserSetting?                           // 用户设置（一对一关系）
  
  // 反向关系字段
  sentFriendRequests     FriendRequest[] @relation("FriendRequestFrom")
  receivedFriendRequests FriendRequest[] @relation("FriendRequestTo")
  sentGroupInvitations   GroupInvitation[] @relation("GroupInvitationInviter")
  receivedGroupInvitations GroupInvitation[] @relation("GroupInvitationInvitee")
}

model VerificationToken {
  identifier String    @id                             // 标识符
  token      String                                   // 验证令牌
  expires    DateTime                                 // 过期时间
  createdAt  DateTime  @default(now())                // 创建时间
}

model Session {
  id           String   @id @default(cuid())          // 会话唯一标识符
  sessionToken String   @unique                       // 会话令牌，全局唯一
  userId       String                                 // 关联的用户ID
  expires      DateTime                               // 过期时间
  user         User     @relation(fields: [userId], references: [id])  // 关联的用户对象
}

model UserWithFriend{
  id        String   @id @default(cuid())            // 好友关系唯一标识符
  userId    String                                   // 用户ID
  friendId  String                                   // 朋友ID
  remark    String?                                  // 备注名，可选
  tag       String?                                  // 标签，可选
  source    String?                                  // 添加来源，可选
  createdAt DateTime @default(now())                 // 创建时间（成为好友的时间）
  
  @@unique([userId, friendId])                       // 用户和朋友ID组合唯一索引
}

model Group{
  id          String   @id @default(cuid())          // 群组唯一标识符
  ownerId     String                                 // 群主ID
  adminIds    String[]                               // 管理员ID数组 包括创建者
  memberIds   String[]                               // 成员ID数组 包括创建者
  name        String                                 // 群名称
  announcement String?                               // 群公告，可选
  createdAt   DateTime @default(now())               // 创建时间
  updatedAt   DateTime @updatedAt                    // 更新时间
  image       String?                                // 群图片
  
  // 反向关系字段
  invitations GroupInvitation[]
}

model UserWithGroup{
  id                  String   @id @default(cuid()) // 用户与群组关系唯一标识符
  userId              String                        // 用户ID
  groupId             String                        // 群组ID
  identity            String                        // 在群中的身份
  nickname            String?                       // 用户在群内的昵称，可选
  remark              String?                       // 群备注，可选
  muteNotification    Boolean  @default(false)      // 是否消息免打扰，默认否
  stickyTopChat       Boolean  @default(false)      // 是否置顶聊天，默认否
  showMemberNameCard  Boolean  @default(true)       // 是否显示群成员名称，默认true
  createdAt           DateTime @default(now())      // 加入群组时间
  updatedAt           DateTime @updatedAt           // 更新时间
  background          String?                       // 聊天背景，可选
  
  @@unique([userId, groupId])                       // 用户和群组ID组合唯一索引
}

model UserSetting{
  id                            String   @id @default(cuid())  // 设置唯一标识符
  userId                        String   @unique                // 关联的用户ID
  newMessageSound               Boolean  @default(true)         // 新消息通知是否有声音

  // 添加好友设置
  needVerificationToAddFriend   Boolean  @default(true)         // 加我为朋友时是否需要验证
  canBeSearchedByChatId         Boolean  @default(true)         // 是否能够通过chatId搜索到我
  canBeSearchedByEmail          Boolean  @default(true)         // 是否能够通过邮箱搜索到我
  canAddFromGroup               Boolean  @default(true)         // 是否能通过群聊添加我
  
  // 通用设置
  language                      String   @default("zh")         // 语言设置 (zh: 中文, en: 英文)
  fontSize                      Int      @default(14)           // 字体大小设置
  openFileInReadonlyMode        Boolean  @default(false)        // 是否以只读的方式打开聊天中的文件
  showWebSearchHistory          Boolean  @default(true)         // 是否显示网络搜索历史
  autoConvertVoiceToText        Boolean  @default(true)         // 是否将聊天语音自动转成文字
  
  createdAt                     DateTime @default(now())        // 设置创建时间
  updatedAt                     DateTime @updatedAt             // 设置更新时间
  
  user                          User     @relation(fields: [userId], references: [id])  // 关联的用户对象
}

model FriendRequest {
  id              String    @id @default(cuid())             // 请求唯一标识符
  fromUserId      String                                   // 发起请求的用户ID
  toUserId        String                                   // 接收请求的用户ID
  status          String    @default("pending")             // 请求状态: pending, accepted, rejected
  requestMessage  String?                                  // 请求附加的消息
  createdAt       DateTime  @default(now())                 // 请求创建时间
  updatedAt       DateTime  @updatedAt                      // 请求更新时间
  
  fromUser        User      @relation(name: "FriendRequestFrom", fields: [fromUserId], references: [id])  // 发起请求的用户对象
  toUser          User      @relation(name: "FriendRequestTo", fields: [toUserId], references: [id])    // 接收请求的用户对象
  
  @@index([fromUserId])
  @@index([toUserId])
}

model GroupInvitation {
  id              String    @id @default(cuid())           // 邀请唯一标识符
  groupId         String                                   // 被邀请的群组ID
  inviterId       String                                   // 邀请人ID
  inviteeId       String                                   // 被邀请人ID
  status          String    @default("pending")            // 邀请状态: pending, accepted, rejected
  inviteMessage   String?                                  // 邀请附加的消息
  createdAt       DateTime  @default(now())                // 邀请创建时间
  updatedAt       DateTime  @updatedAt                     // 邀请更新时间
  
  group           Group     @relation(fields: [groupId], references: [id])     // 群组对象
  inviter         User      @relation(name: "GroupInvitationInviter", fields: [inviterId], references: [id])   // 邀请人对象
  invitee         User      @relation(name: "GroupInvitationInvitee", fields: [inviteeId], references: [id])   // 被邀请人对象
  
  @@index([groupId])
  @@index([inviterId])
  @@index([inviteeId])
}