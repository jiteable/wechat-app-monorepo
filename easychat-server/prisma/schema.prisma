// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  // NOTE: When using mysql or sqlserver, uncomment the @db.Text annotations in model Account below
  // Further reading:
  // https://next-auth.js.org/adapters/prisma#create-the-prisma-schema
  // https://www.prisma.io/docs/reference/api-reference/prisma-schema-reference#string
  url      = env("DATABASE_URL")
}

model User {
  id            String        @id @default(cuid())       // 用户唯一标识符
  chatId        String        @unique                    // 用户聊天ID，全局唯一
  username      String?                                // 用户名，可选
  email         String        @unique                    // 邮箱地址，全局唯一
  emailVerified DateTime?                              // 邮箱验证时间，可选
  avatar        String?                                // 头像图片链接，可选
  password      String                                 // 密码
  gender        String                                 // 性别
  signature     String                                 // 个性签名
  region        String                                 // 地区
  createdAt     DateTime      @default(now())           // 账户创建时间
  updatedAt     DateTime      @updatedAt                // 最后更新时间
  sessions      Session[]                              // 用户会话列表（一对多关系）
  labels        String[]                               // 用户添加的标签（保留此字段用于其他用途）
  settings      UserSetting?                           // 用户设置（一对一关系）
  
  // 反向关系字段
  sentFriendRequests     FriendRequest[] @relation("FriendRequestFrom")
  receivedFriendRequests FriendRequest[] @relation("FriendRequestTo")
  sentGroupInvitations   GroupInvitation[] @relation("GroupInvitationInviter")
  receivedGroupInvitations GroupInvitation[] @relation("GroupInvitationInvitee")
  
  // 消息相关关系
  sentMessages           UnifiedMessage[]      @relation("SentMessages")
  receivedMessages       UnifiedMessage[]      @relation("ReceivedMessages")

  
  // 会话相关关系
  chatSessions           ChatSessionUser[]  // 用户参与的聊天会话
  
  // 好友关系
  friends                UserWithFriend[] @relation("UserFriends")
  friendOf               UserWithFriend[] @relation("FriendRefOfUser")
  
  // 文件关系
  uploadedFiles             File[]           // 用户上传的文件
  
  // 用户创建的标签关系
  createdLabels           UserLabel?        // 用户创建的所有标签
}

model VerificationToken {
  identifier String    @id                             // 标识符
  token      String                                   // 验证令牌
  expires    DateTime                                 // 过期时间
  createdAt  DateTime  @default(now())                // 创建时间
}

model Session {
  id           String   @id @default(cuid())          // 会话唯一标识符
  sessionToken String   @unique                       // 会话令牌，全局唯一
  userId       String                                 // 关联的用户ID
  expires      DateTime                               // 过期时间
  user         User     @relation(fields: [userId], references: [id])  // 关联的用户对象
}

model UserWithFriend{
  id        String   @id @default(cuid())            // 好友关系唯一标识符
  userId    String                                   // 用户ID
  friendId  String                                   // 朋友ID
  remark    String?                                  // 备注名，可选
  tag       String?                                  // 标签，可选
  source    String?                                  // 添加来源，可选
  description String?                                // 描述
  phone     String?                                  // 电话
  createdAt DateTime @default(now())                 // 创建时间（成为好友的时间）
  
  user      User      @relation("UserFriends", fields: [userId], references: [id], onDelete: Cascade)
  friend    User      @relation("FriendRefOfUser", fields: [friendId], references: [id], onDelete: Cascade)
  
  @@unique([userId, friendId])                       // 用户和朋友ID组合唯一索引
}

model Group {
  id          String   @id @default(cuid())          // 群组唯一标识符
  ownerId     String                                 // 群主ID
  adminIds    String[]                               // 管理员ID数组 包括创建者
  memberIds   String[]                               // 成员ID数组 包括创建者
  name        String                                 // 群名称
  announcement String?                               // 群公告，可选
  createdAt   DateTime @default(now())               // 创建时间
  updatedAt   DateTime @updatedAt                    // 更新时间
  image       String?                                // 群图片
  type        String   @default("normal")            // 群组类型: normal, work
  mutedMembers String[]                             // 禁言成员列表
  allowMembersInvite Boolean @default(true)         // 是否允许成员邀请新成员
  needApprovalToJoin Boolean @default(true)         // 是否需要审批才能加入
  isDismissed Boolean  @default(false)               // 群组是否已解散
  dismissedAt DateTime?                              // 群组解散时间
  
  // 反向关系字段
  invitations GroupInvitation[]
  messages    UnifiedMessage[] @relation("GroupMessages")
  chatSession ChatSession?                         
}

model UserSetting{
  id                            String   @id @default(cuid())  // 设置唯一标识符
  userId                        String   @unique                // 关联的用户ID
  newMessageSound               Boolean  @default(true)         // 新消息通知是否有声音

  // 添加好友设置
  needVerificationToAddFriend   Boolean  @default(true)         // 加我为朋友时是否需要验证
  canBeSearchedByChatId         Boolean  @default(true)         // 是否能够通过chatId搜索到我
  canBeSearchedByEmail          Boolean  @default(true)         // 是否能够通过邮箱搜索到我
  canAddFromGroup               Boolean  @default(true)         // 是否能通过群聊添加我
  
  // 通用设置
  language                      String   @default("zh")         // 语言设置 (zh: 中文, en: 英文)
  fontSize                      Int      @default(14)           // 字体大小设置
  openFileInReadonlyMode        Boolean  @default(false)        // 是否以只读的方式打开聊天中的文件
  showWebSearchHistory          Boolean  @default(true)         // 是否显示网络搜索历史
  autoConvertVoiceToText        Boolean  @default(true)         // 是否将聊天语音自动转成文字
  StorageLocation               String   @default("D:\\EasyChat\\files\\")  // 文件保存路径
  
  createdAt                     DateTime @default(now())        // 设置创建时间
  updatedAt                     DateTime @updatedAt             // 设置更新时间
  
  user                          User     @relation(fields: [userId], references: [id])  // 关联的用户对象
}

model FriendRequest {
  id              String    @id @default(cuid())             // 请求唯一标识符
  fromUserId      String                                   // 发起请求的用户ID
  toUserId        String                                   // 接收请求的用户ID
  status          String    @default("pending")             // 请求状态: pending, accepted, rejected
  requestMessage  String?                                  // 请求附加的消息
  createdAt       DateTime  @default(now())                 // 请求创建时间
  updatedAt       DateTime  @updatedAt                      // 请求更新时间
  
  fromUser        User      @relation(name: "FriendRequestFrom", fields: [fromUserId], references: [id])  // 发起请求的用户对象
  toUser          User      @relation(name: "FriendRequestTo", fields: [toUserId], references: [id])    // 接收请求的用户对象
  
  @@index([fromUserId])
  @@index([toUserId])
}

model GroupInvitation {
  id              String    @id @default(cuid())           // 邀请唯一标识符
  groupId         String                                   // 被邀请的群组ID
  inviterId       String                                   // 邀请人ID
  inviteeId       String                                   // 被邀请人ID
  status          String    @default("pending")            // 邀请状态: pending, accepted, rejected
  inviteMessage   String?                                  // 邀请附加的消息
  createdAt       DateTime  @default(now())                // 邀请创建时间
  updatedAt       DateTime  @updatedAt                     // 邀请更新时间
  
  group           Group     @relation(fields: [groupId], references: [id])     // 群组对象
  inviter         User      @relation(name: "GroupInvitationInviter", fields: [inviterId], references: [id])   // 邀请人对象
  invitee         User      @relation(name: "GroupInvitationInvitee", fields: [inviteeId], references: [id])   // 被邀请人对象
  
  @@index([groupId])
  @@index([inviterId])
  @@index([inviteeId])
}

// 消息状态枚举
enum MessageStatus {
  SENDING
  SENT
  DELIVERED
  READ
}

// 统一消息模型 - 合并私聊和群聊消息
model UnifiedMessage {
  id           String      @id @default(cuid())           // 消息唯一标识符
  sessionId    String                                     // 会话ID
  senderId     String                                     // 发送者ID
  receiverId   String?                                    // 接收者ID (私聊时使用)
  groupId      String?                                    // 群组ID (群聊时使用)
  content      String                                     // 消息内容
  messageType  String      @default("text")               // 消息类型: text, image, file, emoji, voice, video timestamp system
  mediaUrl     String?                                    // 媒体文件URL (图片/文件)
  fileName     String?                                    // 文件名 (针对图片/文件类型消息)
  fileSize     Int?                                       // 文件大小 (针对文件类型消息)
  isRecalled   Boolean     @default(false)                // 是否已撤回
  isDeleted    Boolean     @default(false)                // 是否已删除
  status       MessageStatus @default(SENDING)            // 消息状态 (仅私聊)
  readStatus   Boolean     @default(false)                // 是否已读 (仅私聊)
  createdAt    DateTime    @default(now())                // 消息创建时间
  updatedAt    DateTime    @updatedAt                     // 消息更新时间
  recalledAt   DateTime?                                  // 撤回时间
  deletedAt    DateTime?                                  // 删除时间
  
  // 关系
  session      ChatSession @relation("SessionMessages", fields: [sessionId], references: [id])
  sender       User        @relation("SentMessages", fields: [senderId], references: [id])
  receiver     User?       @relation("ReceivedMessages", fields: [receiverId], references: [id])
  group        Group?      @relation("GroupMessages", fields: [groupId], references: [id])
  file         File?
  
  @@index([sessionId])
  @@index([senderId])
  @@index([receiverId])
  @@index([groupId])
  @@index([createdAt])
}

// 文件模型 - 用于标识群聊或私聊时上传的文件
model File {
  id              String      @id @default(cuid())       // 文件唯一标识符
  name            String                                 // 原始文件名
  url             String                                 // 文件访问URL
  thumbnailUrl    String?                                // 缩略图URL (适用于图片)
  size            Int                                    // 文件大小 (字节)
  mimeType        String                                 // MIME类型
  fileExtension   String?                                // 文件类型后缀
  fileType        String                                 // 文件类型分类 (image/document/video/audio等)
  uploaderId      String                                 // 上传者ID
  unifiedMessageId String?    @unique                    // 关联的统一消息ID
  createdAt       DateTime    @default(now())            // 上传时间
  expireAt        DateTime?                              // 过期时间 (可选)
  sessionId       String?                               // 可选的会话ID，用于快速查询
  video           Video?
  
  // 关系
  uploader         User           @relation(fields: [uploaderId], references: [id])
  unifiedMessage   UnifiedMessage? @relation(fields: [unifiedMessageId], references: [id])
  session         ChatSession? @relation(fields: [sessionId], references: [id])
  
  @@index([uploaderId])
  @@index([unifiedMessageId])
  @@index([createdAt])
  @@index([fileType])
  @@index([sessionId])
}

model Video {
  id              String      @id @default(cuid())       // 视频唯一标识符
  fileId          String      @unique                    // 关联的文件ID
  duration        Float?                                 // 视频时长（秒）
  width           Int?                                   // 视频宽度（像素）
  height          Int?                                   // 视频高度（像素）
  bitrate         Int?                                   // 视频比特率（bps）
  codec           String?                                // 视频编码格式
  fps             Float?                                 // 帧率
  thumbnailUrl    String?                                // 视频缩略图URL
  previewUrl      String?                                // 视频预览URL
  createdAt       DateTime    @default(now())            // 创建时间
  updatedAt       DateTime    @updatedAt                 // 更新时间
  
  // 关系
  file            File        @relation(fields: [fileId], references: [id])  // 关联的文件
  
  @@index([fileId])
  @@index([createdAt])
}

// 聊天会话模型 - 用于确定用户进入的是群聊还是私聊
model ChatSession {
  id              String      @id @default(cuid())       // 会话唯一标识符
  sessionType     String                                 // 会话类型: private(私聊) 或 group(群聊)
  name            String?                                // 会话名称 (群聊名称或私聊时对方的备注名)
  avatar          String?                                // 会话头像 (群头像或对方头像)
  ownerId         String?                                // 会话创建者ID (主要用于群聊)
  createdAt       DateTime    @default(now())            // 会话创建时间
  updatedAt       DateTime    @updatedAt                 // 会话更新时间
  isPinned        Boolean     @default(false)            // 是否置顶
  isMuted         Boolean     @default(false)            // 是否免打扰
  isDeleted       Boolean     @default(false)            // 是否已删除
  deletedAt       DateTime?                              // 删除时间
  
  // 关系
  group           Group?      @relation(fields: [groupId], references: [id])  // 关联的群组 (仅群聊)
  groupId         String?     @unique                                         // 群组ID (仅群聊)
  ChatSessionUsers           ChatSessionUser[]                                // 参与此会话的用户
  unifiedMessages UnifiedMessage[]    @relation("SessionMessages")
  files           File[]                              // 与此会话关联的文件
  
  @@index([sessionType])
  @@index([ownerId])
  @@index([groupId])
}

// 聊天会话用户关系模型 - 记录用户与会话的关系
model ChatSessionUser {
  id                  String   @id @default(cuid()) // 关系唯一标识符
  sessionId           String                        // 会话ID
  userId              String                        // 用户ID
  joinTime            DateTime @default(now())      // 加入时间
  lastReadTime        DateTime @default(now())      // 最后阅读时间
  isMuted             Boolean  @default(false)      // 是否免打扰
  isPinned            Boolean  @default(false)      // 是否置顶
  customRemark        String?                       // 自定义备注名
  unreadCount         Int      @default(0)          // 未读消息数
  sessionType         String                        // 会话类型: private(私聊) 或 group(群聊)
  identity            String?                       // 在群中的身份（仅群聊）
  nickname            String?                       // 用户在群内的昵称（仅群聊）
  remark              String?                       // 群备注（仅群聊）
  showMemberNameCard  Boolean  @default(true)       // 是否显示群成员名称（仅群聊）
  background          String?                       // 聊天背景（仅群聊）
  displayName         String?                       // 显示名称
  displayAvatar       String?                       // 显示头像
  createdAt           DateTime @default(now())      // 关系创建时间
  updatedAt           DateTime @updatedAt           // 关系更新时间
  
  // 关系
  session         ChatSession @relation(fields: [sessionId], references: [id])
  user            User        @relation(fields: [userId], references: [id])
  
  @@unique([sessionId, userId])
  @@index([userId])
  @@index([sessionType])
  @@index([isPinned])
}

model UserLabel {
  id          String    @id @default(cuid())          // 标签唯一标识符
  Labels      String[]                                // 标签名称
  userId      String    @unique                       // 创建标签的用户ID
  
  user        User      @relation(fields: [userId], references: [id])  // 关联的用户
  
  @@unique([Labels, userId])                          // 同一用户不能有重名标签
}